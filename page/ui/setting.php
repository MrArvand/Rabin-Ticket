<?php
if($_SESSION['code_p'] =="24277" || $_SESSION['code_p'] =="25662" || $_SESSION['code_p'] =="1100056" || $_SESSION['code_p'] == "1100085"){ ?>
                   <!-- Row starts -->
            <div class="row gx-3">
              <div class="col-sm-12">
                <div class="card mb-3">
                  <div class="card-header">
                    <h5 class="card-title">ثبت شرکت جدید</h5>
                  </div>
                  <div class="card-body">



                  <form  method="post"   action="?page=s_new_sherkat"  enctype="multipart/form-data">
                    <!-- Row starts -->
                    <div class="row gx-3">
					
					<div class="col-lg-2 col-sm-3 col-6">
                        <div class="mb-3">
                          <label class="form-label" for="name_co">نام شرکت</label>
                          <input type="text" class="form-control" id="name_co" name="name_co" placeholder=" ">
                        </div>
                      </div>
					  
                            <div class="col-lg-2 col-sm-3 col-6">
                        <div class="mb-3">
                          <label class="form-label" for="id_co">ایدی / کد  شرکت</label>
                          <input type="text" class="form-control" id="id_co" name="id_co" placeholder=" ">
                        </div>
                      </div>

                    <!-- Row ends -->

                  </div>
                  <div class="card-footer">
                    <div class="d-flex gap-2 justify-content-end">
                      <button type="reset" class="btn btn-outline-secondary">لغو</button>
                      <button  type="submit"  class="btn btn-primary">ثبت</button>
                    </div>
                  </div>
                  </form>
                </div>
              </div>
            </div>
            </div>
            </div>

<hr>
        




                   <!-- Row starts -->
            <div class="row gx-3">
              <div class="col-sm-12">
                <div class="card mb-3">
                  <div class="card-header">
                    <h5 class="card-title">ثبت دسته کاری جدید</h5>
                  </div>
                  <div class="card-body">



                  <form  method="post"   action="?page=s_new_daste"  enctype="multipart/form-data">
                    <!-- Row starts -->
                    <div class="row gx-3">
					
					<div class="col-lg-2 col-sm-3 col-6">
                        <div class="mb-3">
                          <label class="form-label" for="name_daste">نام دسته کاری</label>
                          <input type="text" class="form-control" id="name_daste" name="name_daste" placeholder=" ">
                        </div>
                      </div>
					  
                       <div class="col-lg-2 col-sm-3 col-6">
                        <div class="mb-3">
                          <label class="form-label" for="id_daste">ایدی / کد  دسته</label>
                          <input type="text" class="form-control" id="id_daste" name="id_daste" placeholder=" ">
                        </div>
                      </div>

                    <!-- Row ends -->

                  </div>
                  <div class="card-footer">
                    <div class="d-flex gap-2 justify-content-end">
                      <button type="reset" class="btn btn-outline-secondary">لغو</button>
                      <button  type="submit"  class="btn btn-primary">ثبت</button>
                    </div>
                  </div>
                  </form>
                </div>
              </div>
            </div>
            </div>
            </div>		
          
          <hr>      
          
          
          
          

                   <!-- Row starts -->
            <div class="row gx-3">
              <div class="col-sm-12">
                <div class="card mb-3">
                  <div class="card-header">
                    <h5 class="card-title">ثبت کاربر پشتیبان</h5>
                  </div>
                  <div class="card-body">



                  <form  method="post"   action="?page=s_new_poshtiban"  enctype="multipart/form-data">
                    <!-- Row starts -->
                    <div class="row gx-3">
					
					<div class="col-lg-2 col-sm-3 col-6">
                        <div class="mb-3">
                          <label class="form-label" for="name_k">نام کاربر</label>
                          <input type="text" class="form-control" id="name_k" name="name_k" placeholder=" ">
                        </div>
                      </div>
					  
                       <div class="col-lg-2 col-sm-3 col-6">
                        <div class="mb-3">
                          <label class="form-label" for="code_k">کد پرسنلی</label>
                          <input type="text" class="form-control" id="code_k" name="code_k" placeholder=" ">
                        </div>
                      </div>

					  
                       <div class="col-lg-2 col-sm-3 col-6">
                        <div class="mb-3">
                          <label class="form-label" for="semat_k">سمت</label>
                          <input type="text" class="form-control" id="semat_k" name="semat_k" placeholder=" ">
                        </div>
                      </div>
					  
					  					  
                       <div class="col-lg-2 col-sm-3 col-6">
                        <div class="mb-3">
                          <label class="form-label" for="tel_k">تلفن</label>
                          <input type="text" class="form-control" id="tel_k" name="tel_k" placeholder=" ">
                        </div>
                      </div>
					  
					 					  					  
                       <div class="col-lg-2 col-sm-3 col-6">
                        <div class="mb-3">
                          <label class="form-label" for="email_k">ایمیل</label>
                          <input type="text" class="form-control" id="email_k" name="email_k" placeholder=" ">
                        </div>
                      </div>
					  
					                         <div class="col-lg-2 col-sm-3 col-6">
                        <div class="mb-3">
                          <label class="form-label" for="passs">پسورد</label>
                          <input type="text" class="form-control" id="passs" name="passs" placeholder=" ">
                        </div>
                      </div>
                    <!-- Row ends -->

                  </div>
                  <div class="card-footer">
                    <div class="d-flex gap-2 justify-content-end">
                      <button type="reset" class="btn btn-outline-secondary">لغو</button>
                      <button  type="submit"  class="btn btn-primary">ثبت</button>
                    </div>
                  </div>
                  </form>
                </div>
              </div>
            </div>
            </div>
            
            
            
            <hr>
        




                   <!-- Row starts -->
            <div class="row gx-3">
              <div class="col-sm-12">
                <div class="card mb-3">
                  <div class="card-header">
                    <h5 class="card-title">ثبت کتگوری های آموزشی</h5>
                  </div>
                  <div class="card-body">



                  <form  method="post"   action="?page=s_new_cat" >
                    <!-- Row starts -->
                    <div class="row gx-3">
					
					<div class="col-lg-2 col-sm-3 col-6">
                        <div class="mb-3">
                          <label class="form-label" for="name_cat_x">نام شاخه </label>
                          <input type="text" class="form-control" id="name_cat_x" name="name_cat_x" placeholder=" ">
                        </div>
                      </div>
					  
                       <div class="col-lg-2 col-sm-3 col-6">
                        <div class="mb-3">
                          <label class="form-label" for="id_cat_y">دسته بندی موضوعی : </label>
                          <select class="form-select" name="id_cat_y" id="id_cat_y">
                                    <option value="new"> عنوان سر شاخه</option>
                          <?php

$Query_dep="SELECT*from daste_mohtava where (fader = 'y' ) ORDER BY name_daste ASC LIMIT 200";
if($Result_dep=mysqli_query($Link,$Query_dep)){
while($q_dep=mysqli_fetch_array($Result_dep)){

?>
                            <option value="<?php echo $q_dep['id_daste']; ?>"><?php echo $q_dep['name_daste']; ?></option>
<?php }} ?>   
                          </select>
                        </div>
                      </div>

                    <!-- Row ends -->

                  </div>
                  <div class="card-footer">
                    <div class="d-flex gap-2 justify-content-end">
                      <button type="reset" class="btn btn-outline-secondary">لغو</button>
                      <button  type="submit"  class="btn btn-primary">ثبت</button>
                    </div>
                  </div>
                  </form>
                </div>
              </div>
            </div>
            </div>
            </div>		
          
          <hr> 
          
          
<?php
// Handle department default form submission
$dept_message = '';
$dept_message_type = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $action = $_POST['action'] ?? '';

    if ($action === 'update_dept_default') {
        $dept_id = mysqli_real_escape_string($Link, $_POST['dept_id'] ?? '');
        $dept_user_code = mysqli_real_escape_string($Link, $_POST['user_code'] ?? '');
        $dept_user_name = mysqli_real_escape_string($Link, $_POST['user_name'] ?? '');

        if (!empty($dept_id)) {
            if (!empty($dept_user_code) && !empty($dept_user_name)) {
                // Update default user
                $update_query = "UPDATE departman SET 
                                default_user_code = '$dept_user_code',
                                default_user_name = '$dept_user_name'
                                WHERE id = '$dept_id'";

                if (mysqli_query($Link, $update_query)) {
                    $dept_message = 'کاربر پیش‌فرض با موفقیت ثبت شد';
                    $dept_message_type = 'success';
                } else {
                    $dept_message = 'خطا در ثبت اطلاعات: ' . mysqli_error($Link);
                    $dept_message_type = 'danger';
                }
            } else {
                // Clear default user
                $update_query = "UPDATE departman SET 
                                default_user_code = '',
                                default_user_name = ''
                                WHERE id = '$dept_id'";

                if (mysqli_query($Link, $update_query)) {
                    $dept_message = 'کاربر پیش‌فرض حذف شد';
                    $dept_message_type = 'success';
                } else {
                    $dept_message = 'خطا در حذف: ' . mysqli_error($Link);
                    $dept_message_type = 'danger';
                }
            }
        }
    }
}

// Get all departments
$departments = [];
$query_depts = "SELECT id, name, default_user_code, default_user_name, vaziat 
                FROM departman 
                WHERE vaziat = 'y' 
                ORDER BY name ASC";
if ($result_depts = mysqli_query($Link, $query_depts)) {
    while ($row = mysqli_fetch_array($result_depts)) {
        $departments[] = $row;
    }
}

// Get all active users for dropdown
$dept_users = [];
$query_users = "SELECT code_p, name, semat 
                FROM karbar 
                WHERE vaziat = 'y' 
                ORDER BY name ASC";
if ($result_users = mysqli_query($Link, $query_users)) {
    while ($row = mysqli_fetch_array($result_users)) {
        $dept_users[] = $row;
    }
}
?>

<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="bi bi-building me-2"></i>مدیریت کاربر پیش‌فرض دپارتمان‌ها
        </h5>
        <p class="text-muted mb-0 mt-2" style="font-size: 0.85rem;">
            <i class="bi bi-info-circle me-1"></i>
            در این بخش می‌توانید برای هر دپارتمان یک کاربر پیش‌فرض تعیین کنید.
            تیکت‌های جدید در هر دپارتمان به صورت خودکار به کاربر پیش‌فرض آن دپارتمان اختصاص می‌یابند.
        </p>
    </div>
    <div class="card-body">
        <?php if ($dept_message): ?>
        <div class="alert alert-<?php echo $dept_message_type; ?> alert-dismissible fade show" role="alert">
            <i
                class="bi bi-<?php echo $dept_message_type === 'success' ? 'check-circle' : 'exclamation-triangle'; ?> me-2"></i>
            <?php echo htmlspecialchars($dept_message); ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <?php endif; ?>

        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th style="width: 5%;">#</th>
                        <th style="width: 35%;">نام دپارتمان</th>
                        <th style="width: 30%;">کاربر پیش‌فرض فعلی</th>
                        <th style="width: 30%;">عملیات</th>
                    </tr>
                </thead>
                <tbody>
                    <?php if (empty($departments)): ?>
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2 opacity-50"></i>
                            هیچ دپارتمانی یافت نشد
                        </td>
                    </tr>
                    <?php else: ?>
                    <?php foreach ($departments as $index => $dept): ?>
                    <tr>
                        <td><?php echo $index + 1; ?></td>
                        <td>
                            <strong><?php echo htmlspecialchars($dept['name']); ?></strong>
                            <br>
                            <small class="text-muted">کد: <?php echo htmlspecialchars($dept['id']); ?></small>
                        </td>
                        <td>
                            <?php if (!empty($dept['default_user_code'])): ?>
                            <span class="badge bg-primary">
                                <i class="bi bi-person-fill me-1"></i>
                                <?php echo htmlspecialchars($dept['default_user_name']); ?>
                            </span>
                            <br>
                            <small class="text-muted">کد:
                                <?php echo htmlspecialchars($dept['default_user_code']); ?></small>
                            <?php else: ?>
                            <span class="text-muted">
                                <i class="bi bi-dash-circle me-1"></i>
                                تعیین نشده
                            </span>
                            <?php endif; ?>
                        </td>
                        <td>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" 
                                    data-bs-target="#userSelectModal_<?php echo $dept['id']; ?>">
                                    <i class="bi bi-person-plus me-1"></i>
                                    <?php echo !empty($dept['default_user_code']) ? 'تغییر کاربر' : 'انتخاب کاربر'; ?>
                                </button>
                                <?php if (!empty($dept['default_user_code'])): ?>
                                <form method="POST" action="" class="d-inline"
                                    onsubmit="return confirm('آیا از حذف کاربر پیش‌فرض اطمینان دارید؟');">
                                    <input type="hidden" name="action" value="update_dept_default">
                                    <input type="hidden" name="dept_id" value="<?php echo htmlspecialchars($dept['id']); ?>">
                                    <input type="hidden" name="user_code" value="">
                                    <input type="hidden" name="user_name" value="">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="حذف کاربر پیش‌فرض">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                                <?php endif; ?>
                            </div>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- User Selection Modals for each department -->
<?php foreach ($departments as $dept): ?>
<div class="modal fade" id="userSelectModal_<?php echo $dept['id']; ?>" tabindex="-1" 
    aria-labelledby="userSelectModalLabel_<?php echo $dept['id']; ?>" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userSelectModalLabel_<?php echo $dept['id']; ?>">
                    <i class="bi bi-person-plus me-2"></i>انتخاب کاربر پیش‌فرض برای: <?php echo htmlspecialchars($dept['name']); ?>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <!-- Filter bar for user search -->
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text bg-transparent border-end-0">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control border-start-0 dept-user-filter" 
                            data-dept="<?php echo $dept['id']; ?>"
                            placeholder="جستجو در لیست کاربران..." autocomplete="off">
                    </div>
                </div>

                <div class="dept-user-table-container" id="userTableContainer_<?php echo $dept['id']; ?>" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover m-0">
                        <thead class="sticky-top" style="background: var(--bs-tertiary-bg);">
                            <tr>
                                <th style="border-radius: 8px 0 0 0;">نام کاربر</th>
                                <th style="border-radius: 0 8px 0 0;">عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($dept_users as $user): ?>
                            <tr class="dept-user-row" data-name="<?php echo strtolower($user['name']); ?>" 
                                data-dept="<?php echo $dept['id']; ?>">
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--bs-primary), var(--bs-info)); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; font-weight: bold;">
                                            <?php echo mb_substr($user['name'], 0, 1, 'UTF-8'); ?>
                                        </div>
                                        <div>
                                            <div><?php echo htmlspecialchars($user['name']); ?></div>
                                            <small class="text-muted"><?php echo htmlspecialchars($user['code_p']); ?></small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <form method="POST" action="">
                                        <input type="hidden" name="action" value="update_dept_default">
                                        <input type="hidden" name="dept_id" value="<?php echo htmlspecialchars($dept['id']); ?>">
                                        <input type="hidden" name="user_code" value="<?php echo htmlspecialchars($user['code_p']); ?>">
                                        <input type="hidden" name="user_name" value="<?php echo htmlspecialchars($user['name']); ?>">
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="bi bi-check2"></i> انتخاب
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>

                <!-- No results message -->
                <div class="dept-no-results text-center text-muted py-4" id="noResults_<?php echo $dept['id']; ?>" style="display: none;">
                    <i class="bi bi-search fs-1 d-block mb-2" style="opacity: 0.5;"></i>
                    <p class="mb-0">هیچ کاربری یافت نشد</p>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
            </div>
        </div>
    </div>
</div>
<?php endforeach; ?>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // User filter functionality for department modals
    const userFilters = document.querySelectorAll('.dept-user-filter');
    
    userFilters.forEach(function(filterInput) {
        filterInput.addEventListener('input', function() {
            const deptId = this.getAttribute('data-dept');
            const filterValue = this.value.toLowerCase().trim();
            const userRows = document.querySelectorAll('.dept-user-row[data-dept="' + deptId + '"]');
            const noResults = document.getElementById('noResults_' + deptId);
            const tableContainer = document.getElementById('userTableContainer_' + deptId);
            let visibleCount = 0;

            userRows.forEach(function(row) {
                const userName = row.getAttribute('data-name');
                const isVisible = userName.includes(filterValue);

                if (isVisible) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Show/hide no results message
            if (visibleCount === 0 && filterValue !== '') {
                noResults.style.display = 'block';
                tableContainer.style.display = 'none';
            } else {
                noResults.style.display = 'none';
                tableContainer.style.display = 'block';
            }
        });
    });

    // Clear filter when modal is closed
    const modals = document.querySelectorAll('[id^="userSelectModal_"]');
    modals.forEach(function(modal) {
        modal.addEventListener('hidden.bs.modal', function() {
            const deptId = this.id.replace('userSelectModal_', '');
            const filterInput = document.querySelector('.dept-user-filter[data-dept="' + deptId + '"]');
            const userRows = document.querySelectorAll('.dept-user-row[data-dept="' + deptId + '"]');
            const noResults = document.getElementById('noResults_' + deptId);
            const tableContainer = document.getElementById('userTableContainer_' + deptId);
            
            if (filterInput) {
                filterInput.value = '';
            }
            userRows.forEach(function(row) {
                row.style.display = '';
            });
            if (noResults) {
                noResults.style.display = 'none';
            }
            if (tableContainer) {
                tableContainer.style.display = 'block';
            }
        });
    });
});
</script>

          <hr>      
          
          
          
          
          
          <?php }else{ ?>
          
          
                            <div class="alert bg-danger alert-dismissible fade show" role="alert">شما درسترسی لازم برای مشاهده این بخش را ندارید <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>

          <?php } ?>
          
          
          
          
          